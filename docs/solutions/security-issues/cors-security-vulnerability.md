---
category: security-issues
title: CORS Security Vulnerability with Wildcard Origins
component: FastAPI CORS Middleware
priority: p1
issue_type: security
tags: [cors, security, authentication, fastapi]
related_issues: []
created_date: 2026-02-04
solved_date: 2026-02-04
---

# CORS Security Vulnerability with Wildcard Origins

## Problem Statement

The FastAPI CORS configuration allowed requests from any origin (`allow_origins=["*"]`) while also enabling credentials (`allow_credentials=True`). This combination is invalid and creates a critical security vulnerability enabling CSRF attacks and credential theft.

**Why this matters:**
- Allows any malicious website to access the API
- Enables credential theft via cross-origin requests
- Violates OWASP security guidelines
- Non-compliant with modern web security standards
- Blocks deployment to production environments

## Symptoms

- API accepts requests from any origin
- Credentials can be sent with wildcard origins
- No restriction on which domains can make authenticated requests
- Vulnerable to CSRF (Cross-Site Request Forgery) attacks

## Investigation Steps

1. Analyzed CORS middleware configuration in `src/invproc/api.py`
2. Identified wildcard origins (`["*"]`) with `allow_credentials=True`
3. Reviewed OWASP and MDN CORS best practices
4. Confirmed this combination violates CORS specification
5. Evaluated multiple solution approaches (whitelist, env-based, proxy)

## Root Cause

The CORS middleware was misconfigured with:
- `allow_origins=["*"]` - allows any origin
- `allow_credentials=True` - enables sending/receiving credentials

This combination is invalid per CORS specification. Modern browsers may reject requests entirely, but older browsers or non-browser clients may allow the vulnerability to be exploited.

## Working Solution

### Configuration Changes

Updated `src/invproc/api.py`:

```python
from fastapi.middleware.cors import CORSMiddleware

# Load CORS origins from environment
allowed_origins = os.getenv(
    "ALLOWED_ORIGINS",
    "http://localhost:3000,https://yourdomain.com"
).split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,  # Changed from wildcard to whitelist
    allow_credentials=False,  # Disabled when using specific origins
    allow_methods=["GET", "POST"],  # Restricted to needed methods
    allow_headers=["Content-Type", "X-API-Key"],  # Restricted to needed headers
)
```

### Environment Variable

Updated `.env.example`:

```bash
# CORS settings - comma-separated list of allowed origins
ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com
```

### Key Changes

1. **Whitelist Origins**: Changed from `["*"]` to `allowed_origins` list loaded from environment
2. **Disable Credentials**: Set `allow_credentials=False` when using whitelist
3. **Restrict Methods**: Only `["GET", "POST"]` allowed
4. **Restrict Headers**: Only `["Content-Type", "X-API-Key"]` allowed
5. **Environment-Based**: Origins configurable via `ALLOWED_ORIGINS` environment variable

## Prevention Strategies

### 1. Use Environment-Based Configuration

Configure different origins for different environments:

```bash
# Development
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080

# Production
ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com
```

### 2. Restrictive Default

Use restrictive defaults instead of permissive settings:

- **Don't** use `allow_origins=["*"]` in production
- **Don't** enable `allow_credentials=True` with wildcard origins
- **Do** restrict methods and headers to minimum required

### 3. Documentation

Document allowed origins in:
- README.md
- API documentation
- Deployment guides
- Environment variable documentation

### 4. Testing

Test CORS configuration:

```bash
# Test that unauthorized origins are blocked
curl -H "Origin: https://malicious-site.com" \
  -H "X-API-Key: test-key" \
  http://localhost:8000/health

# Test that allowed origins work
curl -H "Origin: http://localhost:3000" \
  http://localhost:8000/health
```

### 5. Security Best Practices

Follow OWASP ASVS V5 (Input Validation):

- Validate all origins
- Use explicit allowlists
- Implement proper error responses
- Monitor for unauthorized access attempts
- Log CORS violations

## Cross-References

### Related Issues

- Issue #001: Global State Thread Safety - Related to overall API security hardening
- Issue #004: No Rate Limiting - Complements CORS protection
- See also: `docs/solutions/security-issues/fail-fast-production-config-guards-system-20260227.md`

### Related Documentation

- [OWASP CORS Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [MDN HTTP CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- [FastAPI CORS Middleware](https://fastapi.tiangolo.com/tutorial/cors/)

## Verification

### Acceptance Criteria

- [x] CORS configuration updated to use specific allowed origins (not wildcard)
- [x] `allow_credentials` set to `False` (or True only with specific origins)
- [x] `ALLOWED_ORIGINS` environment variable added to `.env.example`
- [x] Development environment includes `http://localhost:3000` in allowed origins
- [x] All tests pass
- [x] Cross-origin requests from unauthorized origins are blocked
- [x] Security scanner confirms CORS vulnerability is resolved

## Notes

- This fix was part of commit `1fb0682`
- Combined with other P1 fixes for comprehensive security hardening
- All P1 critical issues blocking merge are now resolved
