name: CI

on:
  push:
    branches:
      - main
      - "feat/**"
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - edited
      - labeled
      - unlabeled

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev,api]"

      - name: Run ruff
        run: ruff check src/ tests/

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev,api]"

      - name: Type check with mypy
        run: mypy src/

  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev,api]"

      - name: Run tests with coverage gate
        env:
          MOCK: "true"
        run: python -m pytest

  health-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev,api]"

      - name: Start API
        env:
          PYTHONPATH: src
          MOCK: "true"
        run: |
          uvicorn invproc.api:app --host 127.0.0.1 --port 8000 > /tmp/invproc-api.log 2>&1 &
          echo $! > /tmp/invproc-api.pid

      - name: Wait for /health and verify
        run: |
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8000/health > /tmp/health.json; then
              cat /tmp/health.json
              exit 0
            fi
            sleep 1
          done
          echo "API health check failed"
          cat /tmp/invproc-api.log || true
          exit 1

      - name: Stop API
        if: always()
        run: |
          if [ -f /tmp/invproc-api.pid ]; then
            kill "$(cat /tmp/invproc-api.pid)" || true
          fi

  pr-policy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Validate change-type label and required evidence
        uses: actions/github-script@v7
        with:
          script: |
            const allowed = ["change:feature", "change:refactor", "change:deploy"]
            const labels = (context.payload.pull_request.labels || []).map((l) => l.name)
            const selected = allowed.filter((label) => labels.includes(label))

            if (selected.length !== 1) {
              core.setFailed(
                `Exactly one change-type label is required: ${allowed.join(", ")}. Found: ${selected.join(", ") || "none"}`
              )
              return
            }

            const body = (context.payload.pull_request.body || "").trim()
            const sectionMap = {
              "change:feature": "Feature Test Evidence",
              "change:refactor": "Refactor Regression Evidence",
              "change:deploy": "Deploy Verification Plan",
            }

            function getSectionContent(markdown, heading) {
              const escaped = heading.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")
              const pattern = new RegExp(`###\\s+${escaped}\\s*([\\s\\S]*?)(?=\\n###\\s+|$)`, "i")
              const match = markdown.match(pattern)
              return match ? match[1].trim() : ""
            }

            const requiredSection = sectionMap[selected[0]]
            const sectionContent = getSectionContent(body, requiredSection)

            if (!sectionContent || sectionContent.length < 20) {
              core.setFailed(
                `PR body must include a filled \"${requiredSection}\" section (at least 20 characters).`
              )
              return
            }

            const weakSignals = ["tbd", "todo", "n/a"]
            const lowered = sectionContent.toLowerCase()
            if (weakSignals.some((signal) => lowered.includes(signal))) {
              core.setFailed(
                `\"${requiredSection}\" contains placeholder text (TBD/TODO/N/A). Please provide concrete evidence.`
              )
              return
            }

            core.info(`PR policy passed for ${selected[0]}`)

  quality-gate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - tests
      - health-smoke
      - pr-policy
    steps:
      - name: Quality gate passed
        run: echo "All required PR quality gates passed."

  quality-gate-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - tests
      - health-smoke
    steps:
      - name: Quality gate passed
        run: echo "All required push quality gates passed."
